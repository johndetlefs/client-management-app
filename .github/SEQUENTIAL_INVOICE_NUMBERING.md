# Sequential Invoice Numbering Implementation

## Overview

Sequential invoice numbering has been fully implemented using Firestore transactions to ensure uniqueness and monotonic incrementing per tenant/year.

## Implementation Details

### 1. Data Structure

**Counter Document**

- Path: `tenants/{tenantId}/counters/invoices-{year}`
- Type: `InvoiceCounter` (defined in `src/types/invoice.ts`)
- Fields:
  - `year`: number - The calendar year
  - `lastNumber`: number - The last used invoice number for this year
  - `updatedAt`: Timestamp - Last update time

**Invoice Document**

- `invoiceNumber`: string - Internal sequential number (e.g., "2025-001")
- `invoiceDisplayNumber`: string - Client-facing display number (e.g., "QNTS-5TU72" or "2025-001")

### 2. Numbering Algorithm

The `getNextInvoiceNumber()` function in `src/app/workspace/invoices/actions.ts`:

```typescript
async function getNextInvoiceNumber(
  tenantId: string,
  year: number,
  transaction: FirebaseFirestore.Transaction
): Promise<number>;
```

**Logic:**

1. Reads the counter document for the current year within a transaction
2. If counter exists:
   - Increments `lastNumber` by 1
   - Updates the counter document
3. If counter doesn't exist:
   - Creates new counter with `lastNumber: 1`
4. Returns the next number to use

### 3. Transaction Safety

The `issueInvoice()` function uses a Firestore transaction to ensure atomicity:

```typescript
await adminDb.runTransaction(async (transaction) => {
  // 1. Validate invoice is in draft status
  // 2. Get current year
  // 3. Call getNextInvoiceNumber() within the transaction
  // 4. Format the invoice number
  // 5. Update invoice with number and status
  // 6. Update all locked job items to 'invoiced'
});
```

This ensures that:

- Multiple concurrent invoice creations won't get the same number
- The counter is always incremented atomically
- Invoice numbering is consistent and sequential

### 4. Number Formatting

**Internal Number** (`invoiceNumber`):

- Format: `YYYY-NNN` (e.g., "2025-001", "2025-002")
- Generated by `formatInvoiceNumber(year, number)` in `src/lib/invoice-utils.ts`
- Always sequential and unique per tenant/year
- Used for internal tracking and fallback display

**Display Number** (`invoiceDisplayNumber`):

- If client has `shortcode`: Uses format `SSSS-CCCCC` (e.g., "QNTS-5TU72")
  - `SSSS` = 4-letter client shortcode
  - `CCCCC` = 5-letter random code
- If client has no shortcode: Falls back to `invoiceNumber`
- This is what's shown to clients on invoices and in the UI

### 5. Year-Based Reset

Numbers reset to 1 at the start of each calendar year:

- Counter documents are year-specific (`invoices-2025`, `invoices-2026`, etc.)
- Each year starts fresh from 001
- Previous years' counters remain in Firestore for audit trail

### 6. Security

**Firestore Rules** (`firestore.rules`):

```
match /counters/{counterId} {
  allow read: if belongsToTenant(tenantId);
  allow write: if false;  // Only server-side can write
}
```

Counter documents can only be modified by server-side code (Firebase Admin SDK), preventing client-side tampering.

### 7. UI Display

The UI consistently shows the display number with fallback:

```typescript
{
  invoice.invoiceDisplayNumber || invoice.invoiceNumber || "Draft";
}
```

This appears in:

- Invoice list page (`src/app/workspace/invoices/page.tsx`)
- Invoice detail page (`src/app/workspace/invoices/[id]/page.tsx`)
- Print page (`src/app/workspace/invoices/[id]/print/page.tsx`)

## Testing

To manually test sequential numbering:

1. Start the development server with emulators:

   ```bash
   npm run dev
   ```

2. Create a client with a shortcode (e.g., "QNTS")

3. Create a job and add job items

4. Create multiple draft invoices for the same client

5. Add items and issue each invoice

6. Verify:

   - Each invoice gets a sequential `invoiceNumber` (2025-001, 2025-002, etc.)
   - Display numbers use the client shortcode format
   - No duplicate numbers are generated
   - Counter document exists at `tenants/{tenantId}/counters/invoices-2025`

7. Check the Firestore emulator UI at http://127.0.0.1:4000/firestore to view:
   - Invoice documents with `invoiceNumber` and `invoiceDisplayNumber`
   - Counter document with incrementing `lastNumber`

## Edge Cases Handled

1. **Concurrent Invoice Creation**: Transaction ensures only one invoice gets each number
2. **First Invoice of Year**: Counter document is created with initial value of 1
3. **Client Without Shortcode**: Falls back to sequential number for display
4. **Year Rollover**: New counter document created automatically for new year
5. **Failed Transactions**: Counter is only incremented if entire transaction succeeds

## Migration Notes

If migrating from an existing system:

- Old invoices without `invoiceNumber` will continue to work (UI shows "Draft")
- New invoices will automatically get sequential numbers
- No data migration required - numbering starts fresh from 001

## Related Files

- **Types**: `src/types/invoice.ts` - `InvoiceCounter` interface
- **Actions**: `src/app/workspace/invoices/actions.ts` - `getNextInvoiceNumber()`, `issueInvoice()`
- **Utils**: `src/lib/invoice-utils.ts` - `formatInvoiceNumber()`, `formatInvoiceDisplayNumber()`
- **Security**: `firestore.rules` - Counter document protection
- **UI**: Invoice list/detail/print pages - Display logic

## Compliance

This implementation satisfies Phase 5.3 of the Implementation Plan:

- ✅ Sequential invoice numbers per tenant/year
- ✅ Firestore transaction for atomicity
- ✅ Counter document maintained under `tenants/{tenantId}`
- ✅ Unique and monotonic numbering
- ✅ Server-side enforcement (no client manipulation)
